platform :ios do
  desc "Build and upload to TestApp.io"
  lane :beta do
    gym(
      scheme: "TestCiApp",                    # ✅ Replace with your scheme
      export_method: "ad-hoc",
      clean: true,
      export_options: {
        provisioningProfiles: {
          "com.benhamid.TestCiApp" => "match AdHoc com.benhamid.TestCiApp"
        },
        signingStyle: "automatic"
      },
      allowProvisioningUpdates: true          # ✅ Enable this flag
    )

    ipa_path = Actions.lane_context[SharedValues::IPA_OUTPUT_PATH]

    sh "curl -X POST https://upload.testapp.io \
        -H 'Authorization: Bearer #{ENV['TESTAPPIO_API_TOKEN']}' \
        -F 'file=@#{ipa_path}' \
        -F 'release_notes=Uploaded from GitHub Actions CI'"
  end
end
