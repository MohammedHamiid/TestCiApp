default_platform(:ios)

platform :ios do
  desc "Build and upload app to TestApp.io"
  lane :beta do
    # âœ… Fetch signing certificates and provisioning profiles
    match(
      type: "adhoc",
      readonly: false,
      app_identifier: "com.benhamid.TestCiApp"
    )

    # âœ… Build the app
    build_app(
      scheme: "TestCiApp",             # ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù€ scheme Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Xcode
      export_method: "ad-hoc",         # Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ "ad-hoc" Ù…Ø´ "adhoc"
      export_options: {
        provisioningProfiles: {
          "com.benhamid.TestCiApp" => "match AdHoc com.benhamid.TestCiApp"
        }
      }
    )

    # Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù€ IPA Ø§Ù„Ù…Ø¨Ù†ÙŠ
    ipa_path = lane_context[SharedValues::IPA_OUTPUT_PATH]

    # âœ… Upload to TestApp.io Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… curl
    sh("curl -X POST \"https://api.testapp.io/upload\" " \
       "-H \"Authorization: Bearer #{ENV['TESTAPPIO_API_TOKEN']}\" " \
       "-F \"file=@#{ipa_path}\" " \
       "-F \"release_notes=Uploaded from GitHub Actions ğŸš€\"")
  end
end
